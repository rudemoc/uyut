<!-- /templates/profile.html -->

{% extends "base.html" %}
{% block content %}
<div id="main">
    <div class="header">
        <h1>–ü—Ä–æ—Ñ–∏–ª—å</h1>
    </div>

    <form method="post" enctype="multipart/form-data" class="form-container">
        <div class="profile-header">
            <div class="avatar-section">
                <img id="avatar-preview" src="data:image/png;base64,{{ user.avatar }}" 
                     class="avatar" style="width: 120px; height: 120px;">
                <div style="margin-top: 10px;">
                    <label for="avatar" class="file-upload-button">
                        üì∑ –ò–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä
                    </label>
                    <input type="file" name="avatar" id="avatar" accept="image/png,image/jpeg,image/gif" 
                           style="display: none;">
                    <input type="hidden" name="crop_data" id="crop-data">
                    <div style="color: #8899a6; font-size: 0.8em; margin-top: 5px;">
                        PNG, JPG –∏–ª–∏ GIF, –±—É–¥–µ—Ç —É–º–µ–Ω—å—à–µ–Ω–æ –¥–æ 256x256px
                    </div>
                </div>
            </div>
            <div class="profile-info">
                <h2 style="margin: 0; color: #d9d9d9;">{{ user.display_name }}</h2>
                <p style="margin: 5px 0; color: #8899a6;">@{{ user.username }}</p>
                <p style="margin: 0; color: #8899a6; font-size: 0.9em;">{{ user.email }}</p>
                <p style="margin: 5px 0; color: #8899a6; font-size: 0.8em;">
                    –ù–∞ —Å–∞–π—Ç–µ —Å {{ user.created_at | datetime }}
                </p>
            </div>
        </div>

        <div class="form-group">
            <label for="display_name">–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è:</label>
            <input type="text" name="display_name" id="display_name" 
                   value="{{ user.display_name }}" 
                   maxlength="30"
                   style="background-color: #253341; color: #d9d9d9; border: 1px solid #38444d; padding: 12px; border-radius: 8px; width: 100%;">
        </div>

        <div class="form-group">
            <label for="bio">–û —Å–µ–±–µ:</label>
            <textarea name="bio" id="bio" rows="3" 
                      placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ..." 
                      maxlength="160"
                      style="background-color: #253341; color: #d9d9d9; border: 1px solid #38444d; padding: 12px; border-radius: 8px; width: 100%; resize: vertical; min-height: 80px;">{{ user.bio or '' }}</textarea>
        </div>

        {% if error %}
        <div class="error-message" style="color: #e0245e; background: #2d1a23; padding: 12px; border-radius: 8px; border: 1px solid #e0245e; margin: 10px 0;">
            {{ error }}
        </div>
        {% endif %}

        {% if success %}
        <div class="success-message" style="color: #19cf86; background: #1a2d26; padding: 12px; border-radius: 8px; border: 1px solid #19cf86; margin: 10px 0;">
            {{ success }}
        </div>
        {% endif %}

        <button type="submit" class="submit-button" style="background-color: #19cf86; color: #15202b; border: none; padding: 12px 24px; border-radius: 20px; font-weight: bold; width: 100%; cursor: pointer; font-size: 1em; margin-top: 15px;">
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
        </button>
    </form>

    <div class="profile-security" style="margin-top: 20px; padding: 20px; background: #253341; border-radius: 16px; border: 1px solid #38444d;">
        <h3 style="color: #d9d9d9; margin-top: 0;">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h3>
        <a href="{{ url_for('change_password') }}" class="security-button" style="display: block; color: #19cf86; text-decoration: none; padding: 12px; border: 1px solid #38444d; border-radius: 8px; text-align: center; margin-top: 10px; transition: all 0.2s ease;">
            üîí –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
        </a>
    </div>

    <div class="profile-actions">
        <a href="{{ url_for('home') }}" class="back-button">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        <a href="{{ url_for('logout') }}" class="logout-button">–í—ã–π—Ç–∏</a>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–±—Ä–µ–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∫–∏ -->
<div id="crop-modal" class="modal hidden">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 style="margin: 0; color: #d9d9d9;">–û–±—Ä–µ–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–∫–∏</h3>
            <button type="button" id="cancel-crop-button" class="close-button">‚úï</button>
        </div>
        <div class="modal-body">
            <div style="max-height: 400px; overflow: hidden; background: #15202b; padding: 10px; border-radius: 8px;">
                <img id="crop-image" style="max-width: 100%; display: block;">
            </div>
            <div style="color: #8899a6; font-size: 0.8em; margin-top: 10px; text-align: center;">
                –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å –¥–ª—è –æ–±—Ä–µ–∑–∫–∏. –ê–≤–∞—Ç–∞—Ä–∫–∞ –±—É–¥–µ—Ç –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–π 256x256px.
            </div>
            <div class="modal-actions" style="margin-top: 15px; display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" id="crop-button" class="submit-button" style="padding: 8px 16px;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –æ–±—Ä–µ–∑–∫—É</button>
                <button type="button" id="cancel-crop-button-2" class="cancel-button">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>
</div>

<style>
.profile-header {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 20px;
    padding: 20px;
    background: #253341;
    border-radius: 16px;
    border: 1px solid #38444d;
}

.avatar-section {
    text-align: center;
}

.file-upload-button {
    background: #19cf86;
    color: #15202b;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: bold;
    display: inline-block;
    transition: all 0.2s ease;
}

.file-upload-button:hover {
    background: #16b677;
}

.profile-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
    gap: 10px;
}

.back-button {
    color: #19cf86;
    text-decoration: none;
    padding: 10px 20px;
    border: 1px solid #38444d;
    border-radius: 20px;
    display: inline-block;
    text-align: center;
    flex: 1;
    transition: all 0.2s ease;
}

.back-button:hover {
    background: #253341;
}

.logout-button {
    color: #e0245e;
    text-decoration: none;
    padding: 10px 20px;
    border: 1px solid #38444d;
    border-radius: 20px;
    display: inline-block;
    text-align: center;
    flex: 1;
    transition: all 0.2s ease;
}

.logout-button:hover {
    background: #2d1a23;
}

.security-button:hover {
    background: #38444d;
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal.hidden {
    display: none;
}

.modal-content {
    background: #253341;
    border-radius: 16px;
    border: 1px solid #38444d;
    width: 90%;
    max-width: 500px;
}

.modal-header {
    padding: 15px 20px;
    border-bottom: 1px solid #38444d;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-body {
    padding: 20px;
}

.cancel-button {
    background: #38444d;
    color: #d9d9d9;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.cancel-button:hover {
    background: #47525c;
}

@media (max-width: 800px) {
    .profile-header {
        flex-direction: column;
        text-align: center;
        gap: 10px;
    }
    
    .profile-actions {
        flex-direction: column;
    }
    
    .back-button, .logout-button {
        width: 100%;
    }
    
    .modal-content {
        width: 95%;
        margin: 10px;
    }
}
</style>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Cropper.js -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

<script>
// –£–ª—É—á—à–µ–Ω–Ω—ã–π JavaScript –¥–ª—è –æ–±—Ä–µ–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∫–∏
document.addEventListener('DOMContentLoaded', function() {
    let cropper = null;
    
    const avatarInput = document.getElementById('avatar');
    const avatarPreview = document.getElementById('avatar-preview');
    const cropModal = document.getElementById('crop-modal');
    const cropImage = document.getElementById('crop-image');
    const cropButton = document.getElementById('crop-button');
    const cancelCropButton = document.getElementById('cancel-crop-button');
    const cancelCropButton2 = document.getElementById('cancel-crop-button-2');
    const cropDataInput = document.getElementById('crop-data');

    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ñ–∞–π–ª–∞
    if (avatarInput) {
        avatarInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                console.log('File selected:', file.name, file.type, file.size);
                const reader = new FileReader();
                reader.onload = function(e) {
                    console.log('File loaded successfully');
                    cropImage.src = e.target.result;
                    cropModal.classList.remove('hidden');
                    
                    // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π cropper
                    if (cropper) {
                        cropper.destroy();
                    }
                    
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Cropper.js
                    cropper = new Cropper(cropImage, {
                        aspectRatio: 1,
                        viewMode: 1,
                        autoCropArea: 0.8,
                        responsive: true,
                        restore: false,
                        guides: true,
                        center: true,
                        highlight: false,
                        cropBoxMovable: true,
                        cropBoxResizable: true,
                        toggleDragModeOnDblclick: false,
                    });
                    console.log('Cropper initialized');
                };
                reader.onerror = function(e) {
                    console.error('Error reading file:', e);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞');
                };
                reader.readAsDataURL(file);
            }
        });
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function closeCropModal() {
        cropModal.classList.add('hidden');
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
        console.log('Crop modal closed');
    }

    if (cancelCropButton) {
        cancelCropButton.addEventListener('click', function() {
            closeCropModal();
            avatarInput.value = '';
        });
    }

    if (cancelCropButton2) {
        cancelCropButton2.addEventListener('click', function() {
            closeCropModal();
            avatarInput.value = '';
        });
    }

    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ–±—Ä–µ–∑–∫–∏
    if (cropButton) {
        cropButton.addEventListener('click', function() {
            if (!cropper) {
                console.error('No cropper instance');
                return;
            }

            console.log('Applying crop...');
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–µ–∑–∫–∏
            const cropData = cropper.getData();
            cropDataInput.value = JSON.stringify(cropData);
            
            // –°–æ–∑–¥–∞–µ–º –æ–±—Ä–µ–∑–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–µ–≤—å—é
            const canvas = cropper.getCroppedCanvas({
                width: 256,
                height: 256,
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high'
            });

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é
            avatarPreview.src = canvas.toDataURL('image/png');
            console.log('Avatar preview updated');

            closeCropModal();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            showMessage('–ê–≤–∞—Ç–∞—Ä–∫–∞ –æ–±—Ä–µ–∑–∞–Ω–∞. –ù–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è" –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è.', 'success');
        });
    }
    
    function showMessage(text, type) {
        // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        const existingMessages = document.querySelectorAll('.avatar-message');
        existingMessages.forEach(msg => msg.remove());
        
        const messageDiv = document.createElement('div');
        messageDiv.className = 'avatar-message';
        messageDiv.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: ${type === 'success' ? '#19cf86' : '#e0245e'};
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 10000;
            font-weight: bold;
        `;
        messageDiv.textContent = text;
        document.body.appendChild(messageDiv);
        
        setTimeout(() => {
            if (document.body.contains(messageDiv)) {
                document.body.removeChild(messageDiv);
            }
        }, 3000);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
    if (avatarInput) {
        avatarInput.addEventListener('change', function(e) {
            const fileName = e.target.files[0]?.name;
            if (fileName) {
                console.log('Selected file:', fileName);
            }
        });
    }
});
</script>
{% endblock %}