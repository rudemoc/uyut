<!-- home.html -->
{% extends "base.html" %}
{% block content %}
<div id="main">
    <div class="header">
        <h1>NIKTOONION</h1>
    </div>

    <form id="home-form" action="/" method="post" enctype="multipart/form-data" class="form-container">
        <div class="form-group">
            <label for="name">Username (optional, anon otherwise):</label>
            
            <input type="text" name="name" id="name" value="{{ name or '' }}" placeholder="Enter username">
        </div>

        <div class="form-group">
            <label for="avatar">Profile Picture (optional, PNG/JPEG):</label>
            <input type="file" name="avatar" id="avatar" accept="image/png,image/jpeg">
        </div>

        <div class="form-group">
            <label>Join a Room</label>
            <div class="input-group">
                <input type="text" name="code" id="code" placeholder="Room code" value="{{ code or '' }}">
                <button type="submit" name="join" id="join-button" value="join">Join</button>
            </div>
        </div>

        <div class="form-group">
            <label>Create a Room</label>
            
            <input type="text" name="title" id="title" placeholder="Room title (optional)" class="title-input">
            
            <label class="inline checkbox-group">
                <input type="checkbox" name="is_public" id="is_public"> Make public
            </label>

            <div class="input-group">
                <button type="submit" name="create" value="create">Create</button>
            </div>
        </div>

        {% if error %}
        <p class="error">{{ error }}</p>
        {% endif %}
    </form>

    <div class="public-rooms-section">
        <h2>Public Rooms</h2>
        <div id="public-rooms" class="room-list">
            <em>Loading public rooms…</em>
        </div>
    </div>
</div>

<script>
    function joinPublic(code) {
        const codeInput = document.getElementById('code');
        codeInput.value = code;
        document.getElementById('join-button').click();
    }

    function renderPublicRooms(rooms) {
        const container = document.getElementById('public-rooms');
        if (!rooms.length) {
            container.innerHTML = '<em>No public rooms yet. Be the first to create one.</em>';
            return;
        }
        container.innerHTML = '';
        rooms.forEach(r => {
            const item = document.createElement('div');
            item.className = 'room-item';
            item.innerHTML = `
                <div class="room-title"><strong>${r.title}</strong></div>
                <div class="room-meta"><span>Code: ${r.code}</span> · <span>${r.members} online</span></div>
                <button type="button" class="join-public" data-code="${r.code}">Join</button>
            `;
            item.querySelector('button.join-public').addEventListener('click', () => joinPublic(r.code));
            container.appendChild(item);
        });
    }

    async function fetchPublicRooms() {
        try {
            const res = await fetch('/api/public-rooms');
            const data = await res.json();
            renderPublicRooms(data.rooms || []);
        } catch (e) {
            console.log('[PublicRooms] fetch error', e);
        }
    }

    fetchPublicRooms();
    setInterval(fetchPublicRooms, 5000);
</script>
{% endblock %}