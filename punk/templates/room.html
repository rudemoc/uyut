<!-- /templates/room.html -->
{% extends "base.html" %}
{% block content %}
<div id="main" class="mobile-optimized">
    <!-- –î–æ–±–∞–≤–ª—è–µ–º –º–æ–±–∏–ª—å–Ω—ã–π —Ö–µ–¥–µ—Ä -->
    <div id="mobile-header" class="mobile-only">
        <button id="mobile-menu-btn" class="mobile-menu-btn">‚ò∞</button>
        <h1 class="mobile-title">{{ title | truncate(20) }}</h1>
        <div class="mobile-actions">
            <button id="mobile-scroll-down" class="mobile-action-btn">‚Üì</button>
        </div>
    </div>

    <script type="application/json" id="room-messages-data">
        {{ messages | tojson | safe }}
    </script>
    <div id="room-data" 
        data-default-avatar="{{ default_avatar }}"
        data-user-id="{{ user.id }}"
        data-user-name="{{ user.display_name }}"
        data-user-avatar="{{ user.avatar }}"
        data-room-code="{{ room }}"
        style="display: none;">
    </div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —Ö–µ–¥–µ—Ä —Å–∫—Ä—ã–≤–∞–µ–º –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö -->
    <div id="header" class="desktop-only">
        <h1>{{ title }} <small style="color: #8899a6;">({{ room }})</small></h1>
        <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 5px; flex-wrap: wrap;">
            <img src="data:image/png;base64,{{ user.avatar }}" class="avatar" style="width: 24px; height: 24px;">
            <span style="color: #8899a6; font-size: 0.9em;">{{ user.display_name }}</span>
            <a href="{{ url_for('profile') }}" style="color: #19cf86; font-size: 0.8em; margin-left: 10px;">–ü—Ä–æ—Ñ–∏–ª—å</a>
            <a href="{{ url_for('home') }}" style="color: #19cf86; font-size: 0.8em; margin-left: 10px;">–ì–ª–∞–≤–Ω–∞—è</a>
        </div>
    </div>
    
    <div id="messages" class="scroll-container mobile-messages"></div>
    
    <!-- –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö -->
    <form id="send-container" enctype="multipart/form-data" class="mobile-send-container">
        <div class="mobile-toolbar-overlay hidden" id="mobile-toolbar-overlay"></div>
        
        <div class="editor-toolbar mobile-toolbar">
            <button type="button" class="toolbar-button mobile-toolbar-btn" id="bold-btn" title="–ñ–∏—Ä–Ω—ã–π"><strong>B</strong></button>
            <button type="button" class="toolbar-button mobile-toolbar-btn" id="italic-btn" title="–ö—É—Ä—Å–∏–≤"><em>I</em></button>
            <select id="size-select" class="toolbar-button mobile-toolbar-btn" title="–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞">
                <option value="">–†–∞–∑–º–µ—Ä</option>
                <option value="1">–ú–∞–ª–µ–Ω—å–∫–∏–π</option>
                <option value="3">–û–±—ã—á–Ω—ã–π</option>
                <option value="5">–ë–æ–ª—å—à–æ–π</option>
                <option value="7">–û–≥—Ä–æ–º–Ω—ã–π</option>
            </select>
            <button type="button" class="toolbar-button mobile-toolbar-btn" id="emoji-btn" title="–≠–º–æ–¥–∑–∏">üòä</button>
            
            <!-- –£–ª—É—á—à–µ–Ω–Ω—ã–π —Ñ–∞–π–ª–æ–≤—ã–π –∏–Ω–ø—É—Ç –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö -->
            <div class="file-input-container mobile-file-input">
                <button type="button" class="toolbar-button file-input-button mobile-toolbar-btn" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">
                    üìé
                </button>
                <input type="file" id="file-input" name="file" multiple
                    accept="image/*,video/*,audio/*,.gif,.zip,.pdf,.txt,.doc,.docx,.xlsx,.ppt,.pptx"
                    class="mobile-file-input">
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∞ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è —Ç—É–ª–±–∞—Ä–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö -->
            <button type="button" class="toolbar-button mobile-toolbar-btn" id="close-toolbar" style="display: none;">‚úï</button>
        </div>
        
        <div class="resizer-top mobile-resizer" title="–ò–∑–º–µ–Ω–∏—Ç—å –≤—ã—Å–æ—Ç—É –ø–æ–ª—è –≤–≤–æ–¥–∞"></div>
        
        <div id="message-editor" contenteditable="true" data-placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
             class="mobile-editor"></div>
        
        <div class="mobile-send-row">
            <span id="char-counter" class="mobile-char-counter">0/512</span>
            <button type="submit" id="send-button" class="submit-button mobile-send-btn">
                <span class="desktop-only">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span>
                <span class="mobile-only">‚û§</span>
            </button>
        </div>
    </form>
    

    
    <!-- Image viewer for full-size media -->
    <div id="image-viewer" class="image-viewer hidden mobile-image-viewer">
        <div class="image-viewer-content">
            <img id="viewer-image" src="" alt="–ü–æ–ª–Ω–æ—Ä–∞–∑–º–µ—Ä–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" class="mobile-viewer-image">
            <button id="close-viewer" class="close-button mobile-close-btn">‚úï</button>
        </div>
    </div>

    <div id="message-context-menu" class="message-context-menu hidden">
    <div class="context-menu-item" data-action="copy">
        <span class="context-menu-icon">üìã</span>
        <span class="context-menu-text">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç</span>
    </div>
    <div class="context-menu-item" data-action="edit" style="display: none;">
        <span class="context-menu-icon">‚úèÔ∏è</span>
        <span class="context-menu-text">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
    </div>
    <div class="context-menu-item" data-action="delete" style="display: none;">
        <span class="context-menu-icon">üóëÔ∏è</span>
        <span class="context-menu-text">–£–¥–∞–ª–∏—Ç—å</span>
    </div>
    <div class="context-menu-item" data-action="reply">
        <span class="context-menu-icon">‚Ü©Ô∏è</span>
        <span class="context-menu-text">–û—Ç–≤–µ—Ç–∏—Ç—å</span>
    </div>
    <div class="context-menu-item context-menu-cancel">
        <span class="context-menu-text">–û—Ç–º–µ–Ω–∞</span>
    </div>
</div>
    


    <!-- Cooldown overlay -->
    <div id="cooldown-overlay" class="cooldown-overlay hidden mobile-cooldown">
        <div class="cooldown-timer">
            <span id="cooldown-seconds">1</span> —Å–µ–∫—É–Ω–¥–∞ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            <div class="cooldown-progress"></div>
        </div>
    </div>

    <!-- –ú–æ–±–∏–ª—å–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div id="mobile-nav" class="mobile-nav hidden">
        <div class="mobile-nav-content">
            <a href="{{ url_for('home') }}" class="mobile-nav-item">üè† –ì–ª–∞–≤–Ω–∞—è</a>
            <a href="{{ url_for('notifications_page') }}" class="mobile-nav-item">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</a>
            <a href="{{ url_for('profile') }}" class="mobile-nav-item">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
            <div class="mobile-nav-item mobile-nav-close">‚úï –ó–∞–∫—Ä—ã—Ç—å</div>
        </div>
    </div>
</div>

<style>
/* –ú–æ–±–∏–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
.mobile-only { display: none; }
.desktop-only { display: block; }

/* –ú–æ–±–∏–ª—å–Ω—ã–π —Ö–µ–¥–µ—Ä */
#mobile-header {
    position: sticky;
    top: 0;
    z-index: 1000;
    background: var(--primary-bg);
    border-bottom: 1px solid var(--border-color);
    padding: 12px 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
}

.mobile-menu-btn {
    background: none;
    border: none;
    color: var(--text-primary);
    font-size: 1.4em;
    padding: 8px;
    border-radius: 8px;
}

.mobile-title {
    margin: 0;
    font-size: 1.1em;
    color: var(--text-primary);
    text-align: center;
    flex: 1;
    padding: 0 10px;
}

.mobile-action-btn {
    background: var(--secondary-bg);
    border: none;
    color: var(--text-primary);
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* –°–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
.mobile-messages {
    padding-bottom: 80px; /* –ú–µ—Å—Ç–æ –¥–ª—è –ø–æ–ª—è –≤–≤–æ–¥–∞ */
}

/* –ü–æ–ª–µ –≤–≤–æ–¥–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
.mobile-send-container {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--primary-bg);
    border-top: 1px solid var(--border-color);
    padding: 10px 12px;
    padding-bottom: max(12px, env(safe-area-inset-bottom));
}

.mobile-editor {
    min-height: 44px;
    max-height: 30vh;
    font-size: 16px; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑—É–º –≤ iOS */
}

.mobile-send-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 8px;
}

.mobile-send-btn {
    min-width: 50px;
    min-height: 44px;
    border-radius: 50%;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mobile-char-counter {
    font-size: 0.75em;
    color: var(--text-secondary);
}

/* –¢—É–ª—É–±–∞—Ä –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
.mobile-toolbar {
    position: relative;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
}

.mobile-toolbar::-webkit-scrollbar {
    display: none;
}

.mobile-toolbar-btn {
    flex-shrink: 0;
    min-width: 44px;
    min-height: 44px;
}

/* –ú–æ–±–∏–ª—å–Ω–æ–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é */
.mobile-context-menu {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--secondary-bg);
    border-radius: 16px 16px 0 0;
    z-index: 2000;
    padding: 20px 0;
    max-height: 80vh;
    overflow-y: auto;
}

.mobile-context-menu .context-menu-item {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-color);
    font-size: 1.1em;
    -webkit-tap-highlight-color: transparent;
}

.context-menu-cancel {
    color: var(--error);
    font-weight: bold;
    margin-top: 10px;
    border-top: 1px solid var(--border-color);
    border-bottom: none !important;
}

/* –ú–æ–±–∏–ª—å–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è */
.mobile-nav {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    z-index: 3000;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
}

.mobile-nav-content {
    background: var(--secondary-bg);
    border-radius: 20px 20px 0 0;
    padding: 30px 20px;
}

.mobile-nav-item {
    display: block;
    padding: 18px 20px;
    color: var(--text-primary);
    text-decoration: none;
    font-size: 1.2em;
    border-bottom: 1px solid var(--border-color);
    -webkit-tap-highlight-color: transparent;
}

.mobile-nav-close {
    color: var(--error);
    font-weight: bold;
    margin-top: 20px;
    border-top: 2px solid var(--border-color);
    border-bottom: none !important;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .mobile-only { display: flex; }
    .desktop-only { display: none; }
    
    #header { display: none; }
    
    .message {
        padding: 12px 15px;
        margin-bottom: 15px;
    }
    
    .avatar {
        width: 38px;
        height: 38px;
    }
    
    .media-preview {
        max-width: 100%;
    }
    
    .audio-container, .video-container {
        max-width: 100%;
    }
}

@media (max-width: 480px) {
    .mobile-title {
        font-size: 1em;
    }
    
    .message {
        padding: 10px 12px;
        gap: 8px;
    }
    
    .avatar {
        width: 34px;
        height: 34px;
    }
    
    .mobile-send-container {
        padding: 8px 10px;
        padding-bottom: max(10px, env(safe-area-inset-bottom));
    }
    
    .mobile-toolbar-btn {
        min-width: 40px;
        min-height: 40px;
        padding: 6px;
    }
}

/* –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∑–æ–Ω—ã –¥–ª—è iPhone X –∏ –Ω–æ–≤–µ–µ */
@supports(padding: max(0px)) {
    .mobile-send-container {
        padding-left: max(10px, env(safe-area-inset-left));
        padding-right: max(10px, env(safe-area-inset-right));
    }
    
    #mobile-header {
        padding-left: max(15px, env(safe-area-inset-left));
        padding-right: max(15px, env(safe-area-inset-right));
    }
}

/* –£–ª—É—á—à–µ–Ω–∏—è –¥–ª—è –∫–∞—Å–∞–Ω–∏–π */
@media (hover: none) and (pointer: coarse) {
    .message:hover {
        background: transparent;
    }
    
    .message:active {
        background: rgba(37, 51, 65, 0.3);
    }
    
    .toolbar-button:active {
        transform: scale(0.95);
    }
}

/* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –∫–∞—Å–∞–Ω–∏–∏ */
.mobile-context-menu, .mobile-nav, .mobile-toolbar-btn {
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

/* –£–ª—É—á—à–µ–Ω–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
.mobile-messages::-webkit-scrollbar {
    width: 3px;
}

.mobile-messages::-webkit-scrollbar-thumb {
    background: var(--border-color);
}


/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é —Å–æ–æ–±—â–µ–Ω–∏–π */
.message-context-menu {
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 400px;
    background: var(--secondary-bg);
    border-radius: 16px 16px 0 0;
    z-index: 2000;
    box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.5);
    padding: 10px 0;
    display: flex;
    flex-direction: column;
}

.context-menu-item {
    display: flex;
    align-items: center;
    padding: 16px 20px;
    color: var(--text-primary);
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
    transition: background-color 0.2s ease;
    -webkit-tap-highlight-color: transparent;
}

.context-menu-item:last-child {
    border-bottom: none;
}

.context-menu-item:active {
    background: var(--border-color);
}

.context-menu-icon {
    margin-right: 12px;
    font-size: 1.2em;
    width: 24px;
    text-align: center;
}

.context-menu-text {
    flex: 1;
    font-size: 1.1em;
}

.context-menu-cancel {
    color: var(--error);
    font-weight: bold;
    margin-top: 8px;
    border-top: 2px solid var(--border-color);
}

/* –í—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ –¥–æ–ª–≥–æ–º –Ω–∞–∂–∞—Ç–∏–∏ */
.message.selected {
    background: rgba(56, 68, 77, 0.3);
    border-radius: 12px;
}

/* –î–ª—è –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–π –≤–µ—Ä—Å–∏–∏ */
@media (min-width: 769px) {
    .message-context-menu {
        bottom: auto;
        top: 0;
        left: 0;
        transform: none;
        width: auto;
        max-width: 250px;
        border-radius: 12px;
        padding: 8px 0;
    }
    
    .context-menu-item {
        padding: 12px 16px;
        font-size: 0.95em;
    }
}

</style>

<script>
// –ú–æ–±–∏–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è room.js
document.addEventListener('DOMContentLoaded', function() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    initMobileInterface();
});

function initMobileInterface() {
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—é
    const menuBtn = document.getElementById('mobile-menu-btn');
    const mobileNav = document.getElementById('mobile-nav');
    
    if (menuBtn && mobileNav) {
        menuBtn.addEventListener('click', () => {
            mobileNav.classList.remove('hidden');
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é
        mobileNav.addEventListener('click', (e) => {
            if (e.target.classList.contains('mobile-nav-close') || 
                e.target.classList.contains('mobile-nav')) {
                mobileNav.classList.add('hidden');
            }
        });
    }
    
    // –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –≤–Ω–∏–∑
    const scrollDownBtn = document.getElementById('mobile-scroll-down');
    if (scrollDownBtn) {
        scrollDownBtn.addEventListener('click', () => {
            window.roomChat?.scrollToBottom();
        });
    }
    
    // –£–ª—É—á—à–µ–Ω–Ω–æ–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
    setupMobileContextMenu();
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–∞—Å–∞–Ω–∏–π
    setupTouchOptimizations();
}

function setupMobileContextMenu() {
    const contextMenu = document.getElementById('mobile-context-menu');
    
    // –î–æ–ª–≥–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
    document.addEventListener('touchstart', function(e) {
        const message = e.target.closest('.message');
        if (message && window.roomChat) {
            window.roomChat.handleMessageTouchStart(e);
        }
    });
    
    document.addEventListener('touchend', function(e) {
        window.roomChat?.handleMessageTouchEnd(e);
    });
}

function setupTouchOptimizations() {
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥–≤–æ–π–Ω–æ–≥–æ —Ç–∞–ø–∞ –¥–ª—è –∑—É–º–∞
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
            event.preventDefault();
        }
        lastTouchEnd = now;
    }, false);
    
    // –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Å–∞–Ω–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫
    document.addEventListener('touchstart', function(e) {
        if (e.target.classList.contains('toolbar-button') || 
            e.target.classList.contains('mobile-action-btn')) {
            e.target.style.transform = 'scale(0.95)';
        }
    });
    
    document.addEventListener('touchend', function(e) {
        if (e.target.classList.contains('toolbar-button') || 
            e.target.classList.contains('mobile-action-btn')) {
            e.target.style.transform = 'scale(1)';
        }
    });
}
</script>
{% endblock %}